<render>

	<targets>
		<texture name="depth" format="GL_DEPTH_COMPONENT32F" />
		<texture name="normals" format="GL_RGBA16F" />
		<texture name="lights_diffuse" format="GL_R11F_G11F_B10F" />
		<texture name="lights_specular" format="GL_R11F_G11F_B10F" />
		<texture name="HDR" format="GL_R11F_G11F_B10F" />
		<texture name="bloom1" format="GL_R11F_G11F_B10F" size_divisor="4" />
		<texture name="bloom2" format="GL_R11F_G11F_B10F" size_divisor="4" />
		<texture name="pickbuffer" format="GL_R32UI" />
	</targets>

	<pipeline>

		<technique name="picking">
			<depth mask="GL_FALSE" func="GL_EQUAL" />
			<pass name="default">
				<shader name="pickbuffer.vert" type="GL_VERTEX_SHADER" />
				<shader name="pickbuffer.frag" type="GL_FRAGMENT_SHADER" />
				<output texture="depth" /> <!-- early z-cull -->
				<output texture="pickbuffer" />
			</pass>
		</technique>

		<technique name="bbox">
			<pass name="default">
				<shader name="bbox.vert" type="GL_VERTEX_SHADER" />
				<shader name="bbox.geom" type="GL_GEOMETRY_SHADER" />
				<shader name="bbox.frag" type="GL_FRAGMENT_SHADER" />
			</pass>
		</technique>

		<technique name="geometry">
			<depth mask="GL_TRUE" func="GL_LESS" />
			<pass name="simple">
				<shader name="geometry_pass.vert" type="GL_VERTEX_SHADER" />
				<shader name="geometry_pass.frag" type="GL_FRAGMENT_SHADER" />
				<output texture="depth" />
				<output texture="normals" />
			</pass>
			<pass name="normal_map">
				<shader name="geometry_normalmap_pass.vert" type="GL_VERTEX_SHADER" />
				<shader name="geometry_normalmap_pass.frag" type="GL_FRAGMENT_SHADER" />
				<sampler name="normalMap" min_filter="GL_LINEAR" mag_filter="GL_LINEAR" wrap_s="GL_CLAMP_TO_EDGE" wrap_t="GL_CLAMP_TO_EDGE" />
				<output texture="depth" />
				<output texture="normals" />
			</pass>
		</technique>

		<technique name="lights">
			<blend sfactor="GL_ONE" equation="GL_FUNC_ADD" dfactor="GL_ONE" />
			<pass name="directional">
				<shader name="directionnal_light.vert" type="GL_VERTEX_SHADER" />
				<shader name="directionnal_light.frag" type="GL_FRAGMENT_SHADER" />
				<sampler name="normalSampler" min_filter="GL_LINEAR" mag_filter="GL_LINEAR" wrap_s="GL_CLAMP_TO_EDGE" wrap_t="GL_CLAMP_TO_EDGE" />
				<output texture="lights_diffuse" />
				<output texture="lights_specular" />
			</pass>
		</technique>

		<technique name="bloom">
			<pass name="bright">
				<shader name="fullscreen.vert" type="GL_VERTEX_SHADER" />
				<shader name="fullscreen_bright.frag" type="GL_FRAGMENT_SHADER" />
				<output texture="bloom1" />
			</pass>
			<pass name="horizontal_blur">
				<shader name="fullscreen.vert" type="GL_VERTEX_SHADER" />
				<shader name="gaussian_blur_h.frag" type="GL_FRAGMENT_SHADER" />
				<output texture="bloom2" />
			</pass>
			<pass name="vertical_blur">
				<shader name="fullscreen.vert" type="GL_VERTEX_SHADER" />
				<shader name="gaussian_blur_v.frag" type="GL_FRAGMENT_SHADER" />
				<output texture="bloom1" />
			</pass>
		</technique>

		<technique name="compose">
			<depth mask="GL_FALSE" func="GL_EQUAL" />
			<pass name="default">
				<shader name="full.vert" type="GL_VERTEX_SHADER" />
				<shader name="full.frag" type="GL_FRAGMENT_SHADER" />
				<sampler name="diffuseSampler" min_filter="GL_LINEAR" mag_filter="GL_LINEAR" wrap_s="GL_CLAMP_TO_EDGE" wrap_t="GL_CLAMP_TO_EDGE" />
				<sampler name="specularSampler" min_filter="GL_LINEAR" mag_filter="GL_LINEAR" wrap_s="GL_CLAMP_TO_EDGE" wrap_t="GL_CLAMP_TO_EDGE" />
				<sampler name="shadowMap" min_filter="GL_LINEAR" mag_filter="GL_LINEAR" wrap_s="GL_CLAMP_TO_BORDER" wrap_t="GL_CLAMP_TO_BORDER" compare_mode="GL_COMPARE_REF_TO_TEXTURE" compare_func="GL_LEQUAL" />
				<output texture="depth" /> <!-- early z-cull -->
				<output texture="HDR" />
			</pass>
		</technique>

		<technique name="fog">
			<!-- dst = src.a * dst + 1 * src.rgb -->
			<!-- src.a : Extinction ; src.rgb = Scattering -->
			<blend sfactor="GL_ONE" equation="GL_FUNC_ADD" dfactor="GL_SRC_ALPHA" /> 
			<pass name="simple">
				<shader name="fullscreen.vert" type="GL_VERTEX_SHADER" />
				<shader name="fog_simple.frag" type="GL_FRAGMENT_SHADER" />
				<output texture="HDR" />
			</pass>
<!--
			<pass name="scattering">
				<shader name="fullscreen.vert" type="GL_VERTEX_SHADER" />
				<shader name="fog_scattering.frag" type="GL_FRAGMENT_SHADER" />
				<output texture="HDR" />
			</pass>
			<pass name="godrays">
				<shader name="fullscreen.vert" type="GL_VERTEX_SHADER" />
				<shader name="fog_godrays.frag" type="GL_FRAGMENT_SHADER" />
				<output texture="HDR" />
			</pass>
-->
		</technique>

		<technique name="tonemapping">
			<pass name="with_burnout">
				<shader name="fullscreen.vert" type="GL_VERTEX_SHADER" />
				<shader name="tonemapping.frag" type="GL_FRAGMENT_SHADER" />
			</pass>
		</technique>

		<technique name="blend">
			<blend sfactor="GL_ONE" equation="GL_FUNC_ADD" dfactor="GL_ONE" />
			<pass name="bloom">
				<shader name="fullscreen.vert" type="GL_VERTEX_SHADER" />
				<shader name="fullscreen_color.frag" type="GL_FRAGMENT_SHADER" />
				<sampler name="texSampler" min_filter="GL_LINEAR" mag_filter="GL_LINEAR" wrap_s="GL_CLAMP_TO_EDGE" wrap_t="GL_CLAMP_TO_EDGE" />
			</pass>
		</technique>

		<technique name="debug">
			<pass name="depth">
				<shader name="fullscreen.vert" type="GL_VERTEX_SHADER" />
				<shader name="fullscreen_depth.frag" type="GL_FRAGMENT_SHADER" />
			</pass>
			<pass name="normal">
				<shader name="fullscreen.vert" type="GL_VERTEX_SHADER" />
				<shader name="fullscreen_normal.frag" type="GL_FRAGMENT_SHADER" />
			</pass>
			<pass name="color">
				<shader name="fullscreen.vert" type="GL_VERTEX_SHADER" />
				<shader name="fullscreen_color.frag" type="GL_FRAGMENT_SHADER" />
			</pass>
			<pass name="luminance">
				<shader name="fullscreen.vert" type="GL_VERTEX_SHADER" />
				<shader name="fullscreen_exp.frag" type="GL_FRAGMENT_SHADER" />
			</pass>
		</technique>

	</pipeline>

</render>
